FROM node:alpine

ARG BEPORT=${BEPORT}
ENV BEPORT=${BEPORT}

ARG PGHOST=${PGHOST}
ENV PGHOST=${PGHOST}

ARG PGUSERNAME=${PGUSERNAME}
ENV PGUSERNAME=${PGUSERNAME}

ARG PGPASSWORD=${PGPASSWORD}
ENV PGPASSWORD=${PGPASSWORD}

ARG PGDATABASE=${PGDATABASE}
ENV PGDATABASE=${PGDATABASE}

ARG PGPORT=${PGPORT}
ENV PGPORT=${PGPORT}

ARG CAPTCHA_SECRET_KEY=${CAPTCHA_SECRET_KEY}
ENV CAPTCHA_SECRET_KEY=${CAPTCHA_SECRET_KEY}

ARG OPENAI_API_KEY=${OPENAI_API_KEY}
ENV OPENAI_API_KEY=${OPENAI_API_KEY}

ARG JWT_KEY=${JWT_KEY}
ENV JWT_KEY=${JWT_KEY}

ARG GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}

ARG GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
ENV GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

ARG GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL}
ENV GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL}

ARG CORS_ORIGIN=${CORS_ORIGIN}
ENV CORS_ORIGIN=${CORS_ORIGIN}

ARG INITIAL_USER_EMAIL=${INITIAL_USER_EMAIL}
ENV INITIAL_USER_EMAIL=${INITIAL_USER_EMAIL}

ARG OUATH_FAIL_REDIRECT=${OUATH_FAIL_REDIRECT}
ENV OUATH_FAIL_REDIRECT=${OUATH_FAIL_REDIRECT}

ARG OAUTH_SUCCESS_REDIRECT=${OAUTH_SUCCESS_REDIRECT}
ENV OAUTH_SUCCESS_REDIRECT=${OAUTH_SUCCESS_REDIRECT}

ENV PORT 8080

RUN mkdir -p /app

# Set /app as the working directory
WORKDIR /app

# Copy package.json and package-lock.json
# to the /app working directory
COPY package*.json /app/

RUN npm install --omit=dev

# Copy the rest of our Nest folder into /app
COPY . /app

ENV NODE_ENV=production

# Build Nest
RUN npm run build

EXPOSE 8080

# Run npm dev, as we would via the command line
CMD ["npm", "run", "start:prod"]